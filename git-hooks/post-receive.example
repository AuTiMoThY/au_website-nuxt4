#!/bin/bash
# Git Post-Receive Hook ç¯„ä¾‹
# è¤‡è£½æ­¤æª”æ¡ˆåˆ° .git/hooks/post-receive ä¸¦ä¿®æ”¹è·¯å¾‘

# ============================================
# é…ç½®å€åŸŸ - æ ¹æ“šå¯¦éš›æƒ…æ³ä¿®æ”¹é€™äº›è·¯å¾‘
# ============================================

# å·¥ä½œç›®éŒ„ï¼ˆå¯¦éš›åŸ·è¡Œéƒ¨ç½²çš„è·¯å¾‘ï¼‰
WORK_TREE="/var/www/portfolio-nuxt4"

# Git ç›®éŒ„ï¼ˆå¦‚æžœæ˜¯è£¸å€‰åº«ï¼‰
GIT_DIR="/var/www/portfolio.git"

# Node.js ç‰ˆæœ¬ç®¡ç†å™¨è·¯å¾‘ï¼ˆå¦‚æžœæœ‰ä½¿ç”¨ nvm æˆ– fnmï¼‰
# NVM_PATH="$HOME/.nvm"
# source "$NVM_PATH/nvm.sh"

# ============================================
# éƒ¨ç½²æµç¨‹
# ============================================

echo "ðŸš€ é–‹å§‹è‡ªå‹•éƒ¨ç½²..."
echo "æ™‚é–“: $(date)"

# åˆ‡æ›åˆ°å·¥ä½œç›®éŒ„
cd "$WORK_TREE" || exit

# æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼
echo "ðŸ“¥ æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼..."
if [ -n "$GIT_DIR" ]; then
    git --git-dir="$GIT_DIR" --work-tree="$WORK_TREE" pull origin master
else
    git pull origin master
fi

# æª¢æŸ¥æ˜¯å¦æ‹‰å–æˆåŠŸ
if [ $? -ne 0 ]; then
    echo "âŒ Git pull å¤±æ•—"
    exit 1
fi

# å®‰è£ä¾è³´
echo "ðŸ“¦ å®‰è£ä¾è³´..."
npm install --production

# æ§‹å»ºå°ˆæ¡ˆ
echo "ðŸ”¨ æ§‹å»ºå°ˆæ¡ˆ..."
npm run build

# æª¢æŸ¥æ§‹å»ºæ˜¯å¦æˆåŠŸ
if [ $? -ne 0 ]; then
    echo "âŒ æ§‹å»ºå¤±æ•—"
    exit 1
fi

# é‡å•Ÿæ‡‰ç”¨ç¨‹å¼
echo "ðŸ”„ é‡å•Ÿæ‡‰ç”¨ç¨‹å¼..."
if command -v pm2 &> /dev/null; then
    pm2 restart portfolio || pm2 start ecosystem.config.js
elif command -v systemctl &> /dev/null; then
    sudo systemctl restart portfolio
else
    echo "âš ï¸  æœªæ‰¾åˆ° PM2 æˆ– systemctlï¼Œè«‹æ‰‹å‹•é‡å•Ÿæ‡‰ç”¨ç¨‹å¼"
fi

# é¡¯ç¤ºéƒ¨ç½²çµæžœ
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "æ™‚é–“: $(date)"
echo ""
echo "æŸ¥çœ‹æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹:"
if command -v pm2 &> /dev/null; then
    pm2 status portfolio
fi

